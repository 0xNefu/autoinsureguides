---
// src/components/SearchBar.astro
interface Props {
  searchList: any[]; // ← Consider more specific type if possible, e.g. { title: string; description?: string; content?: string; url: string }[]
}

const { searchList = [] } = Astro.props;
---

<div class="search-bar" id="search-container">
  <div class="relative">
    <input
      type="search"                    <!-- ← Changed to type="search" for better mobile UX (shows X clear button) -->
      placeholder="Start typing to search articles..."
      class="w-full p-3 border rounded-lg dark:bg-gray-800 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
      id="search-input"
      aria-label="Search articles"
      autocomplete="off"
    />
    <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
      <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </div>
  </div>

  <div id="search-results" class="mt-4 hidden bg-white dark:bg-gray-900 border rounded-lg shadow-lg dark:shadow-gray-800/50">
    <!-- Results will appear here -->
  </div>
</div>

<script is:inline>
  window.searchIndex = JSON.stringify({{searchList | safe}});  // ← Use Astro's | safe filter instead of manual JSON.stringify (safer & cleaner)
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const searchContainer = document.getElementById('search-container');

    if (!searchInput || !searchResults || !searchContainer) {
      console.error('Search elements not found');
      return;
    }

    let searchData = [];
    try {
      searchData = JSON.parse(window.searchIndex || '[]');
    } catch (e) {
      console.error('Failed to parse search index:', e);
    }

    if (searchData.length === 0) {
      console.warn('Search index is empty');
    }

    function searchPosts(query) {
      if (!query || query.length < 2) return [];
      const lowerQuery = query.toLowerCase().trim();
      return searchData.filter(item => {
        if (!item) return false;
        return (
          item.title?.toLowerCase().includes(lowerQuery) ||
          item.description?.toLowerCase().includes(lowerQuery) ||
          item.content?.toLowerCase().includes(lowerQuery)
        );
      });
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function displayResults(results) {
      if (results.length === 0) {
        searchResults.innerHTML = `
          <div class="p-6 text-center text-gray-500 dark:text-gray-400">
            No results found. Try different keywords.
          </div>
        `;
        searchResults.classList.remove('hidden');
        return;
      }

      let html = `
        <div class="p-3 text-sm text-gray-600 dark:text-gray-400 border-b dark:border-gray-700">
          Found ${results.length} ${results.length === 1 ? 'result' : 'results'}
        </div>
      `;

      results.slice(0, 10).forEach(item => {
        html += `
          <a href="${escapeHtml(item.url || '/')}" class="block p-4 border-b last:border-b-0 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
            <h3 class="font-medium text-gray-900 dark:text-white">
              ${escapeHtml(item.title || 'Untitled')}
            </h3>
            ${item.description ? `
              <p class="mt-1 text-sm text-gray-600 dark:text-gray-400 line-clamp-2">
                ${escapeHtml(item.description.substring(0, 160))}${item.description.length > 160 ? '...' : ''}
              </p>
            ` : ''}
          </a>
        `;
      });

      if (results.length > 10) {
        html += `
          <div class="p-3 text-center text-sm text-gray-500 dark:text-gray-400">
            ... and ${results.length - 10} more
          </div>
        `;
      }

      searchResults.innerHTML = html;
      searchResults.classList.remove('hidden');
    }

    const debounce = (fn, delay) => {
      let timeoutId;
      return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn(...args), delay);
      };
    };

    const performSearch = debounce(() => {
      const query = searchInput.value.trim();
      if (!query) {
        searchResults.classList.add('hidden');
        return;
      }
      if (query.length < 2) {
        searchResults.innerHTML = `<div class="p-6 text-center text-gray-500 dark:text-gray-400">Type at least 2 characters...</div>`;
        searchResults.classList.remove('hidden');
        return;
      }
      const results = searchPosts(query);
      displayResults(results);
    }, 280);

    searchInput.addEventListener('input', performSearch);
    searchInput.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        searchResults.classList.add('hidden');
        searchInput.blur();
      }
    });

    document.addEventListener('click', e => {
      if (!searchContainer.contains(e.target)) {
        searchResults.classList.add('hidden');
      }
    });

    // Optional: auto-focus on mount (useful for search pages)
    // searchInput.focus();
  });
</script>

<style>
  .search-bar {
    max-width: 640px;
    margin: 0 auto;
    position: relative;
  }

  #search-results {
    position: absolute;
    left: 0;
    right: 0;
    z-index: 50;
    max-height: 420px;
    overflow-y: auto;
    border-radius: 0.5rem;
  }

  #search-results::-webkit-scrollbar {
    width: 6px;
  }

  #search-results::-webkit-scrollbar-track {
    background: transparent;
  }

  #search-results::-webkit-scrollbar-thumb {
    background: #9ca3af;
    border-radius: 3px;
  }

  .dark #search-results::-webkit-scrollbar-thumb {
    background: #6b7280;
  }
</style>