---
import TwSizeIndicator from "@/components/TwSizeIndicator.astro";
import config from "@/config/config.json";
import theme from "@/config/theme.json";
import Footer from "@/partials/Footer.astro";
import Header from "@/partials/Header.astro";
import "@/styles/main.css";
import { AstroFont } from "astro-font";
import SEO from "@/layouts/components/SEO.astro";

// Current path for logging and canonicals
const currentPath = Astro.url.pathname;

// Extract props with strong defaults
const {
  title = '',
  meta_title = '',
  description = '',
  image = '',
  meta_image = '',  // Primary OG image
  noindex = false,
  canonical = '',
  hasGatedContent = false,
  gateType = 'partial'  // 'partial' or 'full'
} = Astro.props;

// Log gate info for debugging
console.log('üéØ Gate Configuration:', {
  path: currentPath,
  hasGatedContent,
  gateType
});

// Font handling
const pf = theme.fonts.font_family.primary || '';
let fontPrimary = '';
if (pf) {
  fontPrimary = pf
    .replace(/\+/g, " ")
    .replace(/:[ital,]*[ital@]*[wght@]*[0-9,;]+/gi, "");
}

// Site base URL with fallback
const siteUrl = config.site?.base_url || config.site?.url || 'https://autoinsureguides.com';

// Final OG image: meta_image > image > config fallback > hardcoded default
const finalImage = meta_image?.trim()
  ? `${siteUrl}${meta_image.startsWith("/") ? "" : "/"}${meta_image}`
  : image?.trim()
    ? `${siteUrl}${image.startsWith("/") ? "" : "/"}${image}`
    : `${siteUrl}${config.metadata?.meta_image || '/images/default-og.jpg'}`;

// Final title, description, canonical
const finalTitle = meta_title || title || config.site?.title || "AutoInsureGuides";
const finalDescription = description || config.metadata?.meta_description || config.site?.description || '';
const cleanPath = Astro.url.pathname.replace(/\/$/, "");
const finalCanonical = canonical || `${siteUrl}${cleanPath}`;

// Safe author fallback
const metaAuthor = config.metadata?.meta_author || config.site?.title || "AutoInsureGuides";
---

<!doctype html>
<html lang="en">
  <head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V4FBFWMB51"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-V4FBFWMB51');
    </script>

    <!-- Google AdSense - Added for site-wide ads -->
    <script 
      async 
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6121972957488905"
      crossorigin="anonymous">
    </script>

    <link rel="shortcut icon" href="/favicon.png" />
    <meta name="theme-name" content="AutoInsureGuides" />
    <meta name="msapplication-TileColor" content="#1e40af" />
    <meta name="theme-color" content="#1e40af" />
    <meta name="generator" content={Astro.generator} />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <AstroFont
      config={[
        {
          src: [],
          preload: false,
          display: "swap",
          name: fontPrimary || "sans-serif",
          fallback: "sans-serif",
          cssVariable: "font-primary",
          googleFontsURL: pf ? `https://fonts.googleapis.com/css2?family=${pf}&display=swap` : '',
        },
      ]}
    />

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />

    <!-- SEO Component -->
    <SEO
      title={finalTitle}
      description={finalDescription}
      image={finalImage}
      canonical={finalCanonical}
      noindex={!!noindex}
      type="website"
    />

    <!-- Alpine.js for mobile menu & interactive elements -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Schema.org markup -->
    {title && (
      <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "WebSite",
          "name": "AutoInsureGuides",
          "description": "Expert auto insurance guides, reviews, and money-saving tips",
          "url": "https://autoinsureguides.com",
          "publisher": {
            "@type": "Organization",
            "name": "AutoInsureGuides",
            "logo": {
              "@type": "ImageObject",
              "url": "https://autoinsureguides.com/images/logo1.jpg"
            }
          }
        }
      </script>
    )}

    <!-- Article schema (only if not gated) -->
    {hasGatedContent === false && title && description && (
      <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "Article",
          "headline": "{finalTitle}",
          "description": "{finalDescription}",
          "image": "{finalImage}",
          "datePublished": "2024-01-01",
          "dateModified": "2024-01-01",
          "author": {
            "@type": "Organization",
            "name": "AutoInsureGuides"
          },
          "publisher": {
            "@type": "Organization",
            "name": "AutoInsureGuides",
            "logo": {
              "@type": "ImageObject",
              "url": "https://autoinsureguides.com/images/logo1.jpg"
            }
          },
          "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "{Astro.url.origin}{Astro.url.pathname}"
          },
          "isAccessibleForFree": "true",
          "keywords": "auto insurance, car insurance, insurance guide, insurance tips"
        }
      </script>
    )}

    <link rel="alternate" type="application/rss+xml" title="AutoInsureGuides RSS" href="/rss.xml" />
    <link rel="alternate" type="application/feed+json" title="AutoInsureGuides JSON Feed" href="/feed.json" />
    <meta name="author" content={metaAuthor} />

    <!-- Basic ad styles for better rendering -->
    <style>
      .ad-unit {
        margin: 1.5rem auto;
        text-align: center;
        overflow: hidden;
        border-radius: 8px;
        background: #f8fafc;
        padding: 10px;
      }
      .ad-unit ins {
        border: 1px solid #e5e7eb !important;
        border-radius: 6px !important;
      }
      .ad-label {
        font-size: 0.75rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 4px;
        display: block;
      }
    </style>

    <!-- Premium Content Gate Styles -->
    {hasGatedContent && (
      <style>
        .autoinsureguides-gate-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.98); backdrop-filter: blur(20px); z-index: 2147483647; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.4s ease; }
        .autoinsureguides-gate-overlay.active { opacity: 1; display: flex; }
        .autoinsureguides-gate-modal { background: white; border: 2px solid #1e40af; box-shadow: 0 20px 60px rgba(30,64,175,0.15); padding: 3rem; max-width: 500px; width: 90%; border-radius: 16px; animation: modalSlideUp 0.6s cubic-bezier(0.16,1,0.3,1); }
        @keyframes modalSlideUp { from { opacity: 0; transform: translateY(40px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .gate-header { margin-bottom: 2rem; }
        .gate-icon { font-size: 3.5rem; margin-bottom: 1.5rem; color: #1e40af; display: block; }
        .gate-title { font-size: 1.8rem; font-weight: 700; color: #1e293b; }
        .gate-subtitle { font-size: 1.1rem; color: #4b5563; }
        .gate-form { margin: 2rem 0; }
        .gate-input { width: 100%; padding: 1rem 1.25rem; font-size: 1rem; border: 2px solid #d1d5db; border-radius: 12px; margin-bottom: 1rem; transition: all 0.3s ease; }
        .gate-input:focus { border-color: #1e40af; box-shadow: 0 0 0 3px rgba(30,64,175,0.1); outline: none; }
        .gate-button { width: 100%; padding: 1rem 1.25rem; background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .gate-button:hover { background: linear-gradient(135deg, #1e3a8a, #2563eb); transform: translateY(-2px); box-shadow: 0 10px 25px rgba(30,64,175,0.2); }
        .gate-close { position: absolute; top: 1.2rem; right: 1.2rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 50%; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; }
        .gate-close:hover { background: #e2e8f0; }
        .gate-blur { filter: blur(12px); pointer-events: none; user-select: none; opacity: 0.5; transition: filter 0.5s ease; }
        @media (max-width: 640px) { .autoinsureguides-gate-modal { padding: 2rem 1.5rem; width: 95%; } }
      </style>
    )}

    <!-- Force light mode for professional look -->
    <script>
      document.documentElement.classList.remove('dark');
      document.documentElement.setAttribute('data-theme', 'light');
      document.querySelector('meta[name="theme-color"]')?.setAttribute('content', '#1e40af');
    </script>

    <style>
      * { transition: background-color 0.3s ease, color 0.3s ease; }
      body { background-color: #ffffff; color: #1f2937; }
    </style>
  </head>

  <body class="bg-white text-gray-900 font-primary font-normal leading-relaxed">
    <TwSizeIndicator />
    <Header />

    <main id="main-content" class="min-h-[60vh]">
      <slot />
    </main>

    <Footer />

    <!-- Premium Content Gate (only if enabled) -->
    {hasGatedContent && (
      <div id="autoinsureguides-gate" class="autoinsureguides-gate-overlay">
        <div class="autoinsureguides-gate-modal">
          <button class="gate-close" aria-label="Close gate">√ó</button>

          <div class="gate-header">
            <span class="gate-icon">üîê</span>
            <h2 class="gate-title">Unlock Premium Insurance Guides</h2>
            <p class="gate-subtitle">Access expert analysis, exclusive savings strategies, and in-depth coverage guides.</p>
          </div>

          <div class="gate-form">
            <input type="email" class="gate-input" placeholder="your.email@example.com" id="gate-email-input" required>
            <button class="gate-button">Get Free Access</button>
          </div>

          <div class="gate-footer">
            <p class="gate-legal">
              By subscribing, you agree to our <a href="/privacy">Privacy Policy</a>. No spam, just valuable insurance insights.
            </p>
          </div>
        </div>
      </div>
    )}

    <!-- Gate JavaScript (condensed & safe) -->
    {hasGatedContent && (
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const gate = document.getElementById('autoinsureguides-gate');
          const emailInput = document.getElementById('gate-email-input');
          const main = document.querySelector('main');

          if (!gate || !emailInput || !main) return;

          // Show gate after 45s or 50% scroll
          const showGate = () => {
            main.classList.add('gate-blur');
            gate.classList.add('active');
            emailInput.focus();
          };

          // Auto-show after time
          setTimeout(showGate, 45000);

          // Scroll trigger
          window.addEventListener('scroll', () => {
            if ((window.scrollY / (document.body.scrollHeight - window.innerHeight)) >= 0.5) {
              showGate();
              window.removeEventListener('scroll', arguments.callee);
            }
          }, { once: true });

          // Unlock on submit
          document.querySelector('.gate-button')?.addEventListener('click', (e) => {
            e.preventDefault();
            if (emailInput.value.includes('@')) {
              localStorage.setItem('autoinsureguides_subscriber', 'true');
              main.classList.remove('gate-blur');
              gate.classList.remove('active');
              alert('Access granted!');
            } else {
              alert('Please enter a valid email.');
            }
          });

          // Close button
          document.querySelector('.gate-close')?.addEventListener('click', () => {
            main.classList.remove('gate-blur');
            gate.classList.remove('active');
          });
        });
      </script>
    )}
  </body>
</html>