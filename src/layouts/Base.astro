---
import TwSizeIndicator from "@/components/TwSizeIndicator.astro";
import config from "@/config/config.json";
import theme from "@/config/theme.json";
import Footer from "@/partials/Footer.astro";
import Header from "@/partials/Header.astro";
import "@/styles/main.css";
import { AstroFont } from "astro-font";
import { ClientRouter } from "astro:transitions";
import SEO from "@/layouts/components/SEO.astro";

const currentPath = Astro.url.pathname;

// Get frontmatter props
const { 
  title, 
  meta_title, 
  description, 
  image, 
  noindex, 
  canonical,
  hasGatedContent = false,
  gateType = 'partial'
} = Astro.props;

console.log('üéØ Gate Configuration:', {
  path: currentPath,
  hasGatedContent,
  gateType
});

const pf = theme.fonts.font_family.primary;
let fontPrimary;
if (theme.fonts.font_family.primary) {
  fontPrimary = theme.fonts.font_family.primary
    .replace(/\+/g, " ")
    .replace(/:[ital,]*[ital@]*[wght@]*[0-9,;]+/gi, "");
}

export interface Props {
  title?: string;
  meta_title?: string;
  description?: string;
  image?: string;
  noindex?: boolean;
  canonical?: string;
  hasGatedContent?: boolean;
  gateType?: 'partial' | 'full';
}

const finalTitle = meta_title ?? title ?? config.site.title;
const finalDescription = description ?? config.metadata.meta_description;

const finalImage = image && typeof image === 'string' && image.trim()
  ? `${config.site.base_url}${image.startsWith("/") ? "" : "/"}${image}`
  : `${config.site.base_url}${config.metadata.meta_image}`;

const cleanPath = Astro.url.pathname.replace(/\/$/, "");
const finalCanonical = canonical ?? `${config.site.base_url}${cleanPath}`;
---
<!doctype html>
<html lang="en">
  <head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V4FBFWMB51"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-V4FBFWMB51');
    </script>

    <!-- AutoInsureGuides Favicon -->
    <link rel="shortcut icon" href="/favicon.png" />
    
    <meta name="theme-name" content="AutoInsureGuides" />
    <meta name="msapplication-TileColor" content="#1e40af" />
    <meta name="theme-color" content="#1e40af" />
    <meta name="generator" content={Astro.generator} />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <AstroFont
      config={[
        {
          src: [],
          preload: false,
          display: "swap",
          name: fontPrimary!,
          fallback: "sans-serif",
          cssVariable: "font-primary",
          googleFontsURL: `https://fonts.googleapis.com/css2?family=${pf}&display=swap`,
        },
      ]}
    />

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />

    <SEO
      title={finalTitle}
      description={finalDescription}
      image={finalImage}
      canonical={finalCanonical}
      noindex={!!noindex}
      type="website"
    />

    <!-- ALPINE.JS FOR MOBILE MENU (FIX FOR STUCK MENU) -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- SCHEMA MARKUP FOR INSURANCE SITE -->
    {title && (
      <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "WebSite",
          "name": "AutoInsureGuides",
          "description": "Expert auto insurance guides, reviews, and money-saving tips",
          "url": "https://autoinsureguides.com",
          "publisher": {
            "@type": "Organization",
            "name": "AutoInsureGuides",
            "logo": {
              "@type": "ImageObject",
              "url": "https://autoinsureguides.com/images/logo.jpg"
            }
          }
        }
      </script>
    )}

    <!-- INSURANCE-SPECIFIC SCHEMA FOR ARTICLES -->
    {hasGatedContent === false && title && description && (
      <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "Article",
          "headline": "{finalTitle}",
          "description": "{finalDescription}",
          "image": "{finalImage}",
          "datePublished": "2024-01-01",
          "dateModified": "2024-01-01",
          "author": {
            "@type": "Organization",
            "name": "AutoInsureGuides",
            "url": "https://autoinsureguides.com"
          },
          "publisher": {
            "@type": "Organization",
            "name": "AutoInsureGuides",
            "logo": {
              "@type": "ImageObject",
              "url": "https://autoinsureguides.com/images/logo.jpg"
            }
          },
          "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "{Astro.url.origin}{Astro.url.pathname}"
          },
          "isAccessibleForFree": "true",
          "keywords": "auto insurance, car insurance, insurance guide, insurance tips"
        }
      </script>
    )}

    <link rel="alternate" type="application/rss+xml" title="AutoInsureGuides RSS" href="/rss.xml" />
    <link rel="alternate" type="application/feed+json" title="AutoInsureGuides JSON Feed" href="/feed.json" />

    <ClientRouter />
    <meta name="author" content={config.metadata.meta_author} />
    
    <!-- GATE STYLES - INSURANCE PREMIUM CONTENT -->
    {hasGatedContent && (
      <style>
        /* Premium Content Gate - Professional Insurance Style */
        .autoinsureguides-gate-overlay {
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          width: 100vw !important;
          height: 100vh !important;
          background: rgba(255, 255, 255, 0.98) !important;
          backdrop-filter: blur(20px) !important;
          -webkit-backdrop-filter: blur(20px) !important;
          z-index: 2147483647 !important;
          display: none !important;
          justify-content: center !important;
          align-items: center !important;
          opacity: 0 !important;
          transition: opacity 0.4s ease !important;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        }
        
        .autoinsureguides-gate-overlay.active {
          opacity: 1 !important;
          display: flex !important;
        }
        
        /* Gate Modal - Professional Insurance Design */
        .autoinsureguides-gate-modal {
          background: white !important;
          border: 2px solid #1e40af !important;
          box-shadow: 0 20px 60px rgba(30, 64, 175, 0.15) !important;
          padding: 3rem !important;
          max-width: 500px !important;
          width: 90% !important;
          text-align: center !important;
          border-radius: 16px !important;
          position: relative !important;
          animation: modalSlideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) !important;
          transform-origin: center !important;
        }
        
        @keyframes modalSlideUp {
          from {
            opacity: 0;
            transform: translateY(40px) scale(0.9);
          }
          to {
            opacity: 1;
            transform: translateY(0) scale(1);
          }
        }
        
        /* Gate Header */
        .gate-header {
          margin-bottom: 2rem !important;
        }
        
        .gate-icon {
          font-size: 3.5rem !important;
          margin-bottom: 1.5rem !important;
          display: block !important;
          color: #1e40af !important;
        }
        
        .gate-title {
          font-size: 1.8rem !important;
          font-weight: 700 !important;
          margin: 0 0 0.75rem 0 !important;
          color: #1e293b !important;
          line-height: 1.3 !important;
        }
        
        .gate-subtitle {
          font-size: 1.1rem !important;
          color: #4b5563 !important;
          margin: 0 !important;
          line-height: 1.6 !important;
          font-weight: 400 !important;
        }
        
        /* Gate Form */
        .gate-form {
          margin: 2rem 0 !important;
        }
        
        .gate-input {
          width: 100% !important;
          padding: 1rem 1.25rem !important;
          font-size: 1rem !important;
          border: 2px solid #d1d5db !important;
          border-radius: 12px !important;
          margin-bottom: 1rem !important;
          box-sizing: border-box !important;
          transition: all 0.3s ease !important;
          font-family: inherit !important;
          background: white !important;
        }
        
        .gate-input:focus {
          outline: none !important;
          border-color: #1e40af !important;
          box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1) !important;
        }
        
        .gate-button {
          width: 100% !important;
          padding: 1rem 1.25rem !important;
          background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%) !important;
          color: white !important;
          border: none !important;
          font-size: 1rem !important;
          font-weight: 600 !important;
          border-radius: 12px !important;
          cursor: pointer !important;
          transition: all 0.3s ease !important;
          font-family: inherit !important;
        }
        
        .gate-button:hover {
          background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%) !important;
          transform: translateY(-2px) !important;
          box-shadow: 0 10px 25px rgba(30, 64, 175, 0.2) !important;
        }
        
        /* Gate Footer */
        .gate-footer {
          margin-top: 2rem !important;
          padding-top: 1.5rem !important;
          border-top: 1px solid #e5e7eb !important;
        }
        
        .gate-alternative {
          background: transparent !important;
          color: #1e40af !important;
          border: 2px solid #1e40af !important;
          padding: 0.75rem 1.5rem !important;
          font-weight: 600 !important;
          border-radius: 12px !important;
          cursor: pointer !important;
          transition: all 0.3s ease !important;
          font-size: 0.95rem !important;
          font-family: inherit !important;
          width: 100% !important;
          margin-bottom: 1rem !important;
        }
        
        .gate-alternative:hover {
          background: #1e40af !important;
          color: white !important;
        }
        
        .gate-legal {
          font-size: 0.85rem !important;
          color: #6b7280 !important;
          margin-top: 1rem !important;
          line-height: 1.5 !important;
        }
        
        .gate-legal a {
          color: #1e40af !important;
          text-decoration: underline !important;
          font-weight: 500 !important;
        }
        
        /* Close Button */
        .gate-close {
          position: absolute !important;
          top: 1.2rem !important;
          right: 1.2rem !important;
          background: #f8fafc !important;
          border: 1px solid #e2e8f0 !important;
          font-size: 1.5rem !important;
          cursor: pointer !important;
          color: #64748b !important;
          padding: 0.5rem !important;
          border-radius: 50% !important;
          transition: all 0.3s ease !important;
          width: 2.5rem !important;
          height: 2.5rem !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          line-height: 1 !important;
        }
        
        .gate-close:hover {
          color: #1e293b !important;
          background: #e2e8f0 !important;
          border-color: #94a3b8 !important;
        }
        
        /* Content Blur Effect */
        .gate-blur {
          filter: blur(12px) !important;
          pointer-events: none !important;
          user-select: none !important;
          opacity: 0.5 !important;
          transition: filter 0.5s ease, opacity 0.5s ease !important;
        }
        
        /* Responsive */
        @media (max-width: 640px) {
          .autoinsureguides-gate-modal {
            padding: 2rem 1.5rem !important;
            width: 95% !important;
            margin: 1rem !important;
          }
          
          .gate-title {
            font-size: 1.5rem !important;
          }
          
          .gate-subtitle {
            font-size: 1rem !important;
          }
          
          .gate-icon {
            font-size: 2.8rem !important;
          }
        }
      </style>
    )}
    
    <!-- SIMPLE THEME SCRIPT (Light mode only for insurance site) -->
    <script>
      (function() {
        // Force light mode for professional insurance site
        document.documentElement.classList.remove('dark');
        document.documentElement.setAttribute('data-theme', 'light');
        document.querySelector('meta[name="theme-color"]')?.setAttribute('content', '#1e40af');
        localStorage.setItem('theme', 'light');
      })();
    </script>
    
    <style>
      /* Smooth transitions */
      * {
        transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
      }
      
      /* Insurance site specific styles */
      body {
        background-color: #ffffff !important;
        color: #1f2937 !important;
      }
    </style>
  </head>

  <body class="bg-white text-gray-900 font-primary font-normal leading-relaxed">
    <TwSizeIndicator />
    <Header />
    
    <main id="main-content" class="min-h-[60vh]">
      <slot />
    </main>
    
    <Footer />

    <!-- INSURANCE PREMIUM CONTENT GATE -->
    {hasGatedContent && (
      <>
        <!-- Gate HTML Structure -->
        <div id="autoinsureguides-gate" class="autoinsureguides-gate-overlay">
          <div class="autoinsureguides-gate-modal">
            <button class="gate-close" aria-label="Close gate">√ó</button>
            
            <div class="gate-header">
              <span class="gate-icon">üîê</span>
              <h2 class="gate-title">Unlock Premium Insurance Guides</h2>
              <p class="gate-subtitle">Access expert insurance analysis, exclusive savings strategies, and in-depth coverage guides. Join our community of informed insurance shoppers.</p>
            </div>
            
            <div class="gate-form">
              <input type="email" class="gate-input" placeholder="your.email@example.com" id="gate-email-input" required>
              <button class="gate-button">
                Get Free Access
              </button>
            </div>
            
            <div class="gate-footer">
              <button class="gate-alternative">
                Already subscribed? Click to unlock
              </button>
              <p class="gate-legal">
                By subscribing, you agree to our <a href="/privacy">Privacy Policy</a>. 
                No spam, just valuable insurance insights. Unsubscribe anytime.
              </p>
            </div>
          </div>
        </div>
        
        <!-- Gate JavaScript - Insurance Premium Content -->
        <script>
          console.log('üîê INSURANCE PREMIUM GATE: Loading...');
          
          // Configuration
          const GATE_CONFIG = {
            scrollThreshold: 0.5, // 50% scroll
            showAfterSeconds: 45, // 45 seconds timeout
            forceShow: false // Set to true for testing
          };
          
          // Main function
          function initGate() {
            console.log('‚ö° Initializing insurance premium gate...');
            
            // Check if already subscribed
            const hasAccess = localStorage.getItem('autoinsureguides_subscriber') === 'true';
            if (hasAccess && !GATE_CONFIG.forceShow) {
              console.log('‚úÖ Already subscribed');
              return;
            }
            
            // Setup button listeners
            setupButtons();
            
            // FORCE SHOW FOR TESTING - REMOVE LATER
            if (GATE_CONFIG.forceShow) {
              console.log('üß™ FORCE SHOWING GATE FOR TESTING');
              setTimeout(() => {
                showGateWithBlur();
              }, 1000);
            }
            
            console.log('‚è±Ô∏è Setting up scroll monitoring...');
            setupScrollDetection();
          }
          
          // Setup button event listeners
          function setupButtons() {
            console.log('üîß Setting up gate buttons...');
            
            // Unlock button
            const unlockBtn = document.querySelector('.gate-button');
            if (unlockBtn) {
              unlockBtn.addEventListener('click', function(e) {
                e.preventDefault();
                unlockGate();
              });
            }
            
            // Alternative button
            const altBtn = document.querySelector('.gate-alternative');
            if (altBtn) {
              altBtn.addEventListener('click', function(e) {
                e.preventDefault();
                checkExistingSubscription();
              });
            }
            
            // Close button
            const closeBtn = document.querySelector('.gate-close');
            if (closeBtn) {
              closeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                closeGate();
              });
            }
            
            // Email input enter key
            const emailInput = document.getElementById('gate-email-input');
            if (emailInput) {
              emailInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                  e.preventDefault();
                  unlockGate();
                }
              });
            }
          }
          
          // Setup scroll detection
          function setupScrollDetection() {
            let gateShown = false;
            
            function checkScroll() {
              if (gateShown) return;
              
              const scrollPercent = (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100;
              
              if (scrollPercent >= (GATE_CONFIG.scrollThreshold * 100)) {
                gateShown = true;
                console.log('üéØ Reached scroll threshold, showing gate!');
                showGateWithBlur();
                window.removeEventListener('scroll', checkScroll);
              }
            }
            
            window.addEventListener('scroll', checkScroll);
            
            // Also show after timeout
            setTimeout(() => {
              if (!gateShown) {
                gateShown = true;
                console.log('‚è∞ Timeout reached, showing gate!');
                showGateWithBlur();
              }
            }, GATE_CONFIG.showAfterSeconds * 1000);
          }
          
          // Show gate with blur effect
          function showGateWithBlur() {
            console.log('üöÄ Showing insurance premium gate...');
            
            const gate = document.getElementById('autoinsureguides-gate');
            if (!gate) {
              console.error('‚ùå Gate element not found!');
              return;
            }
            
            // Blur main content
            const mainContent = document.querySelector('main');
            if (mainContent) {
              mainContent.classList.add('gate-blur');
            }
            
            // Show gate
            gate.classList.add('active');
            
            // Focus email input
            const emailInput = document.getElementById('gate-email-input');
            if (emailInput) {
              setTimeout(() => {
                emailInput.focus();
              }, 100);
            }
            
            console.log('‚úÖ Gate displayed successfully');
          }
          
          // Unlock gate
          async function unlockGate() {
            console.log('üîì Unlocking insurance premium content...');
            
            const emailInput = document.getElementById('gate-email-input');
            const email = emailInput ? emailInput.value.trim() : '';
            
            if (!email || !email.includes('@')) {
              alert('Please enter a valid email address to continue.');
              if (emailInput) emailInput.focus();
              return;
            }
            
            // Show loading
            const submitBtn = document.querySelector('.gate-button');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Processing...';
            submitBtn.disabled = true;
            
            try {
              // Simulate API call
              await new Promise(resolve => setTimeout(resolve, 1500));
              
              // Grant access
              localStorage.setItem('autoinsureguides_subscriber', 'true');
              localStorage.setItem('autoinsureguides_subscriber_email', email);
              
              // Show success
              const gateIcon = document.querySelector('.gate-icon');
              if (gateIcon) gateIcon.textContent = '‚úÖ';
              
              submitBtn.textContent = 'Access Granted!';
              submitBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #34d399 100%)';
              
              // Remove blur and close gate
              setTimeout(() => {
                const mainContent = document.querySelector('main');
                if (mainContent) {
                  mainContent.classList.remove('gate-blur');
                }
                
                const gate = document.getElementById('autoinsureguides-gate');
                if (gate) {
                  gate.classList.remove('active');
                }
                
                alert(`‚úÖ Welcome! Premium insurance content unlocked for ${email}`);
              }, 1500);
              
            } catch (error) {
              console.error('‚ùå Error:', error);
              alert('An error occurred. Please try again.');
              submitBtn.textContent = originalText;
              submitBtn.disabled = false;
            }
          }
          
          // Check existing subscription
          function checkExistingSubscription() {
            const email = prompt("Enter the email you used to subscribe:");
            
            if (!email) return;
            
            const storedEmail = localStorage.getItem('autoinsureguides_subscriber_email');
            
            if (storedEmail && storedEmail.toLowerCase() === email.toLowerCase()) {
              // Grant access
              const mainContent = document.querySelector('main');
              if (mainContent) {
                mainContent.classList.remove('gate-blur');
              }
              
              const gate = document.getElementById('autoinsureguides-gate');
              if (gate) {
                gate.classList.remove('active');
              }
              
              alert('‚úÖ Access restored! Welcome back.');
            } else {
              alert("Email not found. Please subscribe or check your email for typos.");
            }
          }
          
          // Close gate
          function closeGate() {
            console.log('üö™ Closing gate...');
            const gate = document.getElementById('autoinsureguides-gate');
            if (gate) {
              gate.classList.remove('active');
            }
            
            const mainContent = document.querySelector('main');
            if (mainContent) {
              mainContent.classList.remove('gate-blur');
            }
          }
          
          // Manual test function
          window.testInsuranceGate = function() {
            console.log('üß™ Testing insurance gate');
            showGateWithBlur();
          };
          
          // Start
          document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM loaded, starting insurance gate system...');
            setTimeout(initGate, 500);
          });
        </script>
      </>
    )}
    
    <!-- Simple smooth scrolling -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
          anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            if (targetId === '#') return;
            
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
              window.scrollTo({
                top: targetElement.offsetTop - 100,
                behavior: 'smooth'
              });
            }
          });
        });
      });
    </script>
  </body>
</html>